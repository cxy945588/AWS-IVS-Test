<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IVS Real-Time - ä¸»æ’­ç«¯ (å°ˆæ¥­ç‰ˆ)</title>
    <script src="https://web-broadcast.live-video.net/1.29.0/amazon-ivs-web-broadcast.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #2ecc71;
            margin-bottom: 20px;
        }
        .back-btn {
            background: #34495e;
            color: white;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 20px;
            display: inline-block;
        }
        .layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .control-panel {
            background: #2c3e50;
            padding: 20px;
            border-radius: 8px;
        }
        .section-title {
            color: #3498db;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #ecf0f1;
            font-weight: bold;
            font-size: 14px;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #34495e;
            border-radius: 4px;
            background: #34495e;
            color: white;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            flex: 1;
            min-width: 150px;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-prepare {
            background: #3498db;
            color: white;
        }
        .btn-prepare:hover:not(:disabled) {
            background: #2980b9;
        }
        .btn-join {
            background: #9b59b6;
            color: white;
        }
        .btn-join:hover:not(:disabled) {
            background: #8e44ad;
        }
        .btn-start {
            background: #2ecc71;
            color: white;
        }
        .btn-start:hover:not(:disabled) {
            background: #27ae60;
        }
        .btn-stop {
            background: #e74c3c;
            color: white;
        }
        .btn-stop:hover:not(:disabled) {
            background: #c0392b;
        }
        .btn-leave {
            background: #95a5a6;
            color: white;
        }
        .btn-leave:hover:not(:disabled) {
            background: #7f8c8d;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .video-container {
            background: black;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 2px solid #34495e;
        }
        .video-container.preview {
            border-color: #3498db;
        }
        .video-container.publishing {
            border-color: #2ecc71;
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.5);
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .no-preview {
            text-align: center;
            color: #7f8c8d;
        }
        .no-preview-icon {
            font-size: 64px;
            margin-bottom: 10px;
        }
        .video-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        .live-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #e74c3c;
            padding: 5px 15px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 14px;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .status-bar {
            background: #34495e;
            padding: 15px;
            border-radius: 8px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #2c3e50;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            color: #95a5a6;
        }
        .status-connected {
            color: #2ecc71;
        }
        .status-disconnected {
            color: #e74c3c;
        }
        .status-warning {
            color: #f39c12;
        }
        .status-info {
            color: #3498db;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .stat-card {
            background: #2c3e50;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            font-size: 12px;
            color: #95a5a6;
            margin-top: 5px;
        }
        .logs {
            background: #1a1a1a;
            border: 1px solid #34495e;
            border-radius: 4px;
            padding: 15px;
            max-height: 250px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
        }
        .log-time {
            color: #95a5a6;
        }
        .log-success {
            color: #2ecc71;
        }
        .log-error {
            color: #e74c3c;
        }
        .log-warning {
            color: #f39c12;
        }
        .log-info {
            color: #3498db;
        }
        
        @media (max-width: 1024px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-btn">â† è¿”å›é¦–é </a>
        
        <h1>ğŸ“¹ ä¸»æ’­ç«¯æ§åˆ¶å° (å°ˆæ¥­ç‰ˆ)</h1>
        
        <div class="layout">
            <div class="main-content">
                <div class="control-panel">
                    <label for="token">Stage Token (Publisher)</label>
                    <input type="text" id="token" placeholder="è«‹è²¼ä¸Šå…·æœ‰ PUBLISH æ¬Šé™çš„ Token">
                    
                    <div class="section-title">ç›´æ’­æ§åˆ¶</div>
                    <div class="button-group">
                        <button id="prepare-button" class="btn-prepare">ğŸ“· æº–å‚™æ”åƒé ­</button>
                        <button id="join-button" class="btn-join" disabled>ğŸ”— åŠ å…¥ Stage</button>
                        <button id="publish-button" class="btn-start" disabled>ğŸ¬ é–‹å§‹æ¨æµ</button>
                    </div>
                    <div class="button-group" style="margin-top: 10px;">
                        <button id="stop-button" class="btn-stop" disabled>â¹ï¸ åœæ­¢æ¨æµ</button>
                        <button id="leave-button" class="btn-leave" disabled>ğŸ‘‹ é›¢é–‹ Stage</button>
                    </div>
                </div>
                
                <div id="video-container" class="video-container">
                    <div class="no-preview">
                        <div class="no-preview-icon">ğŸ“¹</div>
                        <div>é»æ“Šã€Œæº–å‚™æ”åƒé ­ã€é–‹å§‹é è¦½</div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="viewers-count">0</div>
                        <div class="stat-label">è§€çœ‹äººæ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="duration">00:00:00</div>
                        <div class="stat-label">æ¨æµæ™‚é•·</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="bitrate">0 kbps</div>
                        <div class="stat-label">ç•¶å‰ä½å…ƒç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="resolution">-</div>
                        <div class="stat-label">è¦–é »è§£æåº¦</div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="status-bar">
                    <div class="status-item">
                        <span class="status-label">æ”åƒé ­ç‹€æ…‹</span>
                        <span id="cameraStatus" class="status-disconnected">æœªå°±ç·’</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Stage é€£ç·š</span>
                        <span id="stageStatus" class="status-disconnected">æœªé€£ç·š</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">æ¨æµç‹€æ…‹</span>
                        <span id="publishStatus" class="status-disconnected">æœªæ¨æµ</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">åœ¨ç·šåƒèˆ‡è€…</span>
                        <span id="participantCount">0</span>
                    </div>
                </div>
                
                <div class="logs" id="logs">
                    <div class="log-info">âœ… ç³»çµ±å°±ç·’</div>
                    <div class="log-info">ğŸ’¡ æ­¥é©Ÿ 1: æº–å‚™æ”åƒé ­</div>
                    <div class="log-info">ğŸ’¡ æ­¥é©Ÿ 2: åŠ å…¥ Stage</div>
                    <div class="log-info">ğŸ’¡ æ­¥é©Ÿ 3: é–‹å§‹æ¨æµ</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { Stage, LocalStageStream, SubscribeType, StageEvents, ConnectionState, StreamType } = IVSBroadcastClient;

        // æŒ‰éˆ•
        const prepareButton = document.getElementById("prepare-button");
        const joinButton = document.getElementById("join-button");
        const publishButton = document.getElementById("publish-button");
        const stopButton = document.getElementById("stop-button");
        const leaveButton = document.getElementById("leave-button");
        
        // ç‹€æ…‹
        let stage;
        let localCamera;
        let localMic;
        let cameraStageStream;
        let micStageStream;
        let localVideoElement;
        let participantCount = 0;
        let startTime = null;
        let durationTimer = null;
        
        // ç‹€æ…‹æ¨™è¨˜
        let isCameraReady = false;
        let isStageJoined = false;
        let shouldPublish = false;  // æ§åˆ¶æ˜¯å¦ç™¼å¸ƒçš„æ¨™è¨˜

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const time = new Date().toLocaleTimeString('zh-TW');
            const entry = document.createElement('div');
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
            logsDiv.insertBefore(entry, logsDiv.firstChild);
            
            while (logsDiv.children.length > 50) {
                logsDiv.removeChild(logsDiv.lastChild);
            }
            
            console.log(`[${type}]`, message);
        }

        function updateStatus(id, text, className) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = text;
                el.className = className;
            }
        }

        function updateDuration() {
            if (startTime) {
                const elapsed = Date.now() - startTime;
                const h = Math.floor(elapsed / 3600000);
                const m = Math.floor((elapsed % 3600000) / 60000);
                const s = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('duration').textContent = 
                    `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            }
        }

        function updateButtonStates() {
            prepareButton.disabled = isCameraReady;
            joinButton.disabled = !isCameraReady || isStageJoined;
            publishButton.disabled = !isStageJoined || shouldPublish;
            stopButton.disabled = !shouldPublish;
            leaveButton.disabled = !isStageJoined || shouldPublish;
        }

        // æ­¥é©Ÿ 1: æº–å‚™æ”åƒé ­
        async function prepareCamera() {
            log('ğŸ“· æ­£åœ¨å•Ÿå‹•æ”åƒé ­å’Œéº¥å…‹é¢¨...', 'info');
            prepareButton.disabled = true;
            
            try {
                // ç²å–æ”åƒé ­
                localCamera = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                });
                log('âœ“ æ”åƒé ­å·²å°±ç·’', 'success');
                
                // ç²å–éº¥å…‹é¢¨
                localMic = await navigator.mediaDevices.getUserMedia({
                    video: false,
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                log('âœ“ éº¥å…‹é¢¨å·²å°±ç·’', 'success');
                
                // é¡¯ç¤ºæœ¬åœ°é è¦½
                const container = document.getElementById('video-container');
                container.innerHTML = '';
                container.classList.add('preview');
                
                localVideoElement = document.createElement('video');
                localVideoElement.id = 'local-preview';
                localVideoElement.autoplay = true;
                localVideoElement.muted = true;
                localVideoElement.playsInline = true;
                localVideoElement.srcObject = localCamera;
                
                container.appendChild(localVideoElement);
                
                // é¡¯ç¤ºè¦–é »è³‡è¨Š
                localVideoElement.addEventListener('loadedmetadata', () => {
                    const resolution = `${localVideoElement.videoWidth}x${localVideoElement.videoHeight}`;
                    document.getElementById('resolution').textContent = resolution;
                    log(`âœ“ è¦–é »è§£æåº¦: ${resolution}`, 'success');
                });
                
                isCameraReady = true;
                updateStatus('cameraStatus', 'å·²å°±ç·’ (é è¦½ä¸­)', 'status-info');
                log('âœ… æ”åƒé ­æº–å‚™å®Œæˆï¼Œå¯ä»¥åŠ å…¥ Stage', 'success');
                
                updateButtonStates();
                
            } catch (err) {
                log(`âŒ ç„¡æ³•ç²å–åª’é«”è¨­å‚™: ${err.message}`, 'error');
                alert(`ç„¡æ³•ç²å–æ”åƒé ­/éº¥å…‹é¢¨:\n${err.message}\n\nè«‹ç¢ºä¿:\n1. å·²å…è¨±ç€è¦½å™¨å­˜å–æ¬Šé™\n2. è¨­å‚™æœªè¢«å…¶ä»–ç¨‹å¼å ç”¨`);
                prepareButton.disabled = false;
            }
        }

        // æ­¥é©Ÿ 2: åŠ å…¥ Stage
        async function joinStage() {
            const token = document.getElementById("token").value.trim();
            if (!token) {
                alert("è«‹å…ˆè¼¸å…¥ Token");
                return;
            }
            
            log('ğŸ”— æ­£åœ¨é€£æ¥ Stage...', 'info');
            joinButton.disabled = true;
            
            try {
                // å‰µå»º StageStreams
                cameraStageStream = new LocalStageStream(localCamera.getVideoTracks()[0]);
                micStageStream = new LocalStageStream(localMic.getAudioTracks()[0]);
                log('âœ“ å·²å»ºç«‹ LocalStageStream', 'success');
                
                // å®šç¾©å‹•æ…‹ç­–ç•¥
                const strategy = {
                    stageStreamsToPublish: () => {
                        // æ ¹æ“š shouldPublish æ¨™è¨˜æ±ºå®šæ˜¯å¦ç™¼å¸ƒ
                        if (shouldPublish) {
                            log('â†’ Strategy: è¿”å›åª’é«”æµé€²è¡Œç™¼å¸ƒ', 'info');
                            return [cameraStageStream, micStageStream];
                        } else {
                            log('â†’ Strategy: ä¸ç™¼å¸ƒä»»ä½•æµ', 'info');
                            return [];
                        }
                    },
                    shouldPublishParticipant: () => {
                        return shouldPublish;
                    },
                    shouldSubscribeToParticipant: () => {
                        return SubscribeType.AUDIO_VIDEO;
                    }
                };
                
                // å‰µå»º Stage
                stage = new Stage(token, strategy);
                log('âœ“ å·²å»ºç«‹ Stage å¯¦ä¾‹', 'success');
                
                // è¨­å®šäº‹ä»¶ç›£è½
                stage.on(StageEvents.STAGE_CONNECTION_STATE_CHANGED, (state) => {
                    log(`ğŸ“¡ é€£ç·šç‹€æ…‹: ${state}`, 'info');
                    
                    if (state === ConnectionState.CONNECTED) {
                        isStageJoined = true;
                        updateStatus('stageStatus', 'å·²é€£ç·š', 'status-connected');
                        log('âœ… å·²æˆåŠŸé€£ç·šåˆ° Stageï¼', 'success');
                        log('ğŸ’¡ ç¾åœ¨å¯ä»¥é–‹å§‹æ¨æµ', 'info');
                        updateButtonStates();
                    } else if (state === ConnectionState.DISCONNECTED) {
                        isStageJoined = false;
                        shouldPublish = false;
                        updateStatus('stageStatus', 'å·²æ–·ç·š', 'status-disconnected');
                        updateButtonStates();
                    }
                });
                
                stage.on(StageEvents.STAGE_PARTICIPANT_JOINED, (participant) => {
                    if (!participant.isLocal) {
                        participantCount++;
                        document.getElementById('participantCount').textContent = participantCount;
                        log(`âœ“ è§€çœ¾åŠ å…¥: ${participant.userId || participant.id}`, 'success');
                    }
                });
                
                stage.on(StageEvents.STAGE_PARTICIPANT_LEFT, (participant) => {
                    if (!participant.isLocal) {
                        participantCount = Math.max(0, participantCount - 1);
                        document.getElementById('participantCount').textContent = participantCount;
                        log(`ğŸ‘‹ è§€çœ¾é›¢é–‹: ${participant.userId || participant.id}`, 'info');
                    }
                });
                
                stage.on(StageEvents.STAGE_PARTICIPANT_STREAMS_ADDED, (participant, streams) => {
                    if (participant.isLocal) {
                        log(`ğŸ‰ æœ¬åœ°ä¸²æµå·²ç™¼å¸ƒ: ${streams.length} å€‹`, 'success');
                        updateStatus('publishStatus', 'æ¨æµä¸­', 'status-connected');
                        updateStatus('cameraStatus', 'ç™¼å¸ƒä¸­', 'status-connected');
                    }
                });
                
                // åŠ å…¥ Stage
                await stage.join();
                log('âœ“ æ­£åœ¨ç­‰å¾…é€£ç·šç¢ºèª...', 'info');
                
            } catch (err) {
                log(`âŒ åŠ å…¥ Stage å¤±æ•—: ${err.message}`, 'error');
                alert(`åŠ å…¥ Stage å¤±æ•—:\n${err.message}`);
                joinButton.disabled = false;
            }
        }

        // æ­¥é©Ÿ 3: é–‹å§‹æ¨æµ
        async function startPublishing() {
            log('ğŸ¬ é–‹å§‹æ¨æµ...', 'info');
            publishButton.disabled = true;
            
            try {
                // è¨­å®šç™¼å¸ƒæ¨™è¨˜
                shouldPublish = true;
                
                // è§¸ç™¼ç­–ç•¥é‡æ–°è©•ä¼°
                stage.refreshStrategy();
                log('âœ“ å·²è§¸ç™¼æ¨æµç­–ç•¥', 'success');
                
                startTime = Date.now();
                durationTimer = setInterval(updateDuration, 1000);
                
                const container = document.getElementById('video-container');
                container.classList.remove('preview');
                container.classList.add('publishing');
                
                // æ·»åŠ  LIVE æ¨™ç±¤
                const liveBadge = document.createElement('div');
                liveBadge.className = 'live-badge';
                liveBadge.id = 'live-badge';
                liveBadge.textContent = 'ğŸ”´ LIVE';
                container.appendChild(liveBadge);
                
                log('âœ… æ¨æµå·²é–‹å§‹ï¼è§€çœ¾ç¾åœ¨å¯ä»¥çœ‹åˆ°æ‚¨çš„ç›´æ’­', 'success');
                updateButtonStates();
                
            } catch (err) {
                log(`âŒ é–‹å§‹æ¨æµå¤±æ•—: ${err.message}`, 'error');
                shouldPublish = false;
                publishButton.disabled = false;
            }
        }

        // åœæ­¢æ¨æµ
        function stopPublishing() {
            log('â¹ï¸ åœæ­¢æ¨æµ...', 'info');
            
            try {
                // å–æ¶ˆç™¼å¸ƒæ¨™è¨˜
                shouldPublish = false;
                
                // è§¸ç™¼ç­–ç•¥é‡æ–°è©•ä¼°
                stage.refreshStrategy();
                log('âœ“ å·²åœæ­¢æ¨æµç­–ç•¥', 'success');
                
                if (durationTimer) {
                    clearInterval(durationTimer);
                    durationTimer = null;
                }
                
                const container = document.getElementById('video-container');
                container.classList.remove('publishing');
                container.classList.add('preview');
                const liveBadge = document.getElementById('live-badge');
                if (liveBadge) liveBadge.remove();
                
                updateStatus('publishStatus', 'æœªæ¨æµ', 'status-disconnected');
                updateStatus('cameraStatus', 'å·²å°±ç·’ (é è¦½ä¸­)', 'status-info');
                document.getElementById('duration').textContent = '00:00:00';
                
                log('âœ“ æ¨æµå·²åœæ­¢ï¼Œä½†ä»é€£ç·šåœ¨ Stage', 'success');
                updateButtonStates();
                
            } catch (err) {
                log(`âŒ åœæ­¢æ¨æµå¤±æ•—: ${err.message}`, 'error');
            }
        }

        // é›¢é–‹ Stage
        function leaveStage() {
            log('ğŸ‘‹ æ­£åœ¨é›¢é–‹ Stage...', 'info');
            
            if (stage) {
                stage.leave();
            }
            
            isStageJoined = false;
            shouldPublish = false;
            participantCount = 0;
            
            if (durationTimer) {
                clearInterval(durationTimer);
                durationTimer = null;
            }
            
            updateStatus('stageStatus', 'å·²æ–·ç·š', 'status-disconnected');
            updateStatus('publishStatus', 'æœªæ¨æµ', 'status-disconnected');
            updateStatus('cameraStatus', 'å·²å°±ç·’ (é è¦½ä¸­)', 'status-info');
            document.getElementById('participantCount').textContent = '0';
            document.getElementById('duration').textContent = '00:00:00';
            
            const container = document.getElementById('video-container');
            container.classList.remove('publishing');
            container.classList.add('preview');
            const liveBadge = document.getElementById('live-badge');
            if (liveBadge) liveBadge.remove();
            
            log('âœ“ å·²é›¢é–‹ Stage', 'success');
            log('ğŸ’¡ æ”åƒé ­ä»åœ¨é è¦½ä¸­ï¼Œå¯ä»¥é‡æ–°åŠ å…¥', 'info');
            updateButtonStates();
        }

        // äº‹ä»¶ç›£è½
        prepareButton.addEventListener("click", prepareCamera);
        joinButton.addEventListener("click", joinStage);
        publishButton.addEventListener("click", startPublishing);
        stopButton.addEventListener("click", stopPublishing);
        leaveButton.addEventListener("click", leaveStage);

        // åˆå§‹åŒ–
        log('ğŸš€ ä¸»æ’­ç«¯å°ˆæ¥­ç‰ˆå·²è¼‰å…¥', 'success');
        log('ğŸ“¦ SDK ç‰ˆæœ¬: 1.29.0', 'info');
        log('', 'info');
        log('ğŸ“‹ ä½¿ç”¨æµç¨‹:', 'info');
        log('1ï¸âƒ£ é»æ“Šã€Œæº–å‚™æ”åƒé ­ã€â†’ é¡¯ç¤ºæœ¬åœ°é è¦½', 'info');
        log('2ï¸âƒ£ é»æ“Šã€ŒåŠ å…¥ Stageã€â†’ é€£æ¥ä½†ä¸æ¨æµ', 'info');
        log('3ï¸âƒ£ é»æ“Šã€Œé–‹å§‹æ¨æµã€â†’ é–‹å§‹ç›´æ’­', 'info');
        log('4ï¸âƒ£ é»æ“Šã€Œåœæ­¢æ¨æµã€â†’ åœæ­¢ä½†ä¿æŒé€£ç·š', 'info');
        log('5ï¸âƒ£ é»æ“Šã€Œé›¢é–‹ Stageã€â†’ å®Œå…¨æ–·é–‹', 'info');
        updateButtonStates();
    </script>
</body>
</html>
